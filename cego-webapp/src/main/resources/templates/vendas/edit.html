<!doctype html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title th:text="'Editar Venda #' + ${venda.id}"></title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .main-layout { display: flex; min-height: 100vh; }
    .content-wrapper { flex-grow: 1; padding: 2rem; overflow-y: auto; }
    .form-card { background-color: #ffffff; border-radius: 1rem; padding: 2.5rem; max-width: 900px; margin: auto; }
    .total-display { font-size: 1.5rem; font-weight: 700; color: #198754; }
    .select2-container--bootstrap-5 .select2-selection { padding: 0.5rem 1rem; height: auto; }
  </style>
</head>
<body>

<div class="main-layout">
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>
  <div class="content-wrapper">
    <div class="form-card">
      <h2 class="fw-bold text-center mb-4" th:text="'Editar Venda #' + ${venda.id}"></h2>
      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

      <form id="venda-form" method="post" th:object="${vendaDTO}" th:action="@{/vendas/edit/{id}(id=${venda.id})}">
        <div class="mb-4">
          <label for="selectCliente" class="form-label fw-semibold">Cliente</label>
          <select id="selectCliente" class="form-select" th:field="*{clienteId}">
            <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nome}"></option>
          </select>
        </div>
        <hr class="my-4">
        <h5 class="mb-3">Itens da Venda</h5>
        <div class="p-3 bg-light rounded-3 border mb-4">
          <div class="row g-3 align-items-end">
            <div class="col-sm-6">
              <label for="produto-select" class="form-label">Adicionar Produto</label>
              <select id="produto-select" class="form-select">
                <option value="">Selecione...</option>
                <option th:each="p : ${produtos}" th:value="${p.id}" th:text="${p.nome}"
                        th:attr="data-nome=${p.nome}, data-preco=${p.preco}, data-estoque=${p.estoque}"
                        th:disabled="${p.estoque <= 0}"></option>
              </select>
            </div>
            <div class="col-sm-3">
              <label for="quantidade-input" class="form-label">Quantidade</label>
              <input type="number" id="quantidade-input" class="form-control" min="1" value="1">
            </div>
            <div class="col-sm-3 d-grid">
              <button type="button" id="add-item-btn" class="btn btn-primary"><i class="bi bi-plus-circle-fill me-1"></i> Adicionar</button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-light">
            <tr><th>Produto</th><th class="text-center">Qtd.</th><th class="text-end">Preço</th><th class="text-end">Subtotal</th><th class="text-center">Ação</th></tr>
            </thead>
            <tbody id="itens-table-body">
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-end align-items-center mt-4">
          <span class="me-3 fs-5 fw-semibold">Total da Venda:</span>
          <span class="total-display" id="total-venda">R$ 0,00</span>
        </div>
        <div class="row g-2 mt-4">
          <div class="col-6 d-grid"><a class="btn btn-outline-danger" th:href="@{/vendas}">Cancelar</a></div>
          <div class="col-6 d-grid"><button type="submit" id="btn-finalizar-venda" class="btn btn-success"><i class="bi bi-check-circle me-2"></i>Salvar Alterações</button></div>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
  /*<![CDATA[*/
  // ### CORREÇÃO 2: Usar 'produtos'
  const todosOsProdutos = /*[[${produtos}]]*/ [];
  const itensIniciais = /*[[${vendaDTO.itens}]]*/ [];
  /*]]>*/

  $(document).ready(function () {
    $('#selectCliente, #produto-select').select2({ theme: "bootstrap-5", placeholder: "Selecione..." });

    const tableBody = $('#itens-table-body');
    const form = $('#venda-form');
    let itemIndex = 0;

    function formatCurrency(value) {
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function updateTotal() {
      let totalVenda = 0;
      tableBody.find('tr').each(function() {
        totalVenda += parseFloat($(this).data('subtotal'));
      });
      $('#total-venda').text(formatCurrency(totalVenda));
      checkFormValidity();
    }

    function checkFormValidity() {
      const temItens = tableBody.find('tr').length > 0;
      $('#btn-finalizar-venda').prop('disabled', !temItens);
    }

    function addItemToTable(produtoId, quantidade) {
      const produto = todosOsProdutos.find(p => p.id === produtoId);
      if (!produto) return;

      const subtotal = produto.preco * quantidade;

      const newRow = `
        <tr data-subtotal="${subtotal}">
            <td>${produto.nome}
                <input type="hidden" name="itens[${itemIndex}].produtoId" value="${produtoId}">
                <input type="hidden" name="itens[${itemIndex}].quantidade" value="${quantidade}">
            </td>
            <td class="text-center">${quantidade}</td>
            <td class="text-end">${formatCurrency(produto.preco)}</td>
            <td class="text-end fw-semibold">${formatCurrency(subtotal)}</td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm btn-remove-item"><i class="bi bi-trash3-fill"></i></button>
            </td>
        </tr>`;
      tableBody.append(newRow);
      itemIndex++;
    }

    // Carrega os itens iniciais
    itensIniciais.forEach(item => addItemToTable(item.produtoId, item.quantidade));
    updateTotal();

    // Adiciona um novo item
    $('#add-item-btn').on('click', function () {
      const selectedOption = $('#produto-select').find('option:selected');
      const produtoId = parseInt(selectedOption.val());
      const quantidade = parseInt($('#quantidade-input').val());

      if (!produtoId) { Swal.fire('Atenção', 'Selecione um produto.', 'warning'); return; }
      if (isNaN(quantidade) || quantidade <= 0) { Swal.fire('Atenção', 'Insira uma quantidade válida.', 'warning'); return; }

      const jaExiste = tableBody.find(`input[name$=".produtoId"][value="${produtoId}"]`).length > 0;
      if (jaExiste) { Swal.fire('Atenção', 'Este produto já está na venda.', 'warning'); return; }

      const produto = todosOsProdutos.find(p => p.id === produtoId);
      if (quantidade > produto.estoque) { Swal.fire('Estoque Insuficiente', `Só existem ${produto.estoque} unidades de ${produto.nome} em estoque.`, 'error'); return; }

      addItemToTable(produtoId, quantidade);
      updateTotal();

      $('#produto-select').val('').trigger('change');
      $('#quantidade-input').val(1);
    });

    // Remove um item
    tableBody.on('click', '.btn-remove-item', function() {
      $(this).closest('tr').remove();
      updateTotal();
    });

    checkFormValidity();
  });
</script>
</body>
</html>