<!doctype html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nova Venda | Gestão Profissional</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .main-layout { display: flex; min-height: 100vh; }
    .content-wrapper { flex-grow: 1; padding: 2rem; overflow-y: auto; }
    .form-card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 8px 30px rgba(0,0,0,0.08); padding: 2.5rem; border: 1px solid #e9ecef; max-width: 900px; margin: auto; }
    .form-card-title { text-align: center; font-weight: 700; color: #343a40; margin-bottom: 2rem; }
    .btn { border-radius: 0.5rem; padding: 0.75rem 1rem; font-weight: 500; }
    .form-control:focus, .form-select:focus { box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15); border-color: #86b7fe; }
    #itens-table-body td { vertical-align: middle; }
    .total-display { font-size: 1.5rem; font-weight: 700; color: #198754; }
    .swal2-html-container ul { margin: 0; padding-left: 1.5rem; }
  </style>
</head>
<body>

<div class="main-layout">
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>
  <div class="content-wrapper">
    <div class="form-card">
      <h2 class="form-card-title">Registrar Nova Venda</h2>

      <form method="post" th:object="${vendaDTO}" th:action="@{/vendas/create}" novalidate>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="mb-4">
          <label for="selectCliente" class="form-label fw-semibold">Cliente</label>
          <select id="selectCliente" class="form-select" th:field="*{clienteId}">
            <option value="">Selecione um cliente...</option>
            <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nome}"></option>
          </select>
        </div>
        <hr class="my-4">
        <h5 class="mb-3">Itens da Venda</h5>
        <div class="p-3 bg-light rounded-3 border mb-4">
          <div class="row g-3 align-items-end">
            <div class="col-sm-6">
              <label for="produto-select" class="form-label">Produto</label>
              <select id="produto-select" class="form-select">
                <option value="">Selecione um produto...</option>
                <option th:each="p : ${produtos}" th:value="${p.id}" th:attr="data-nome=${p.nome}, data-preco=${p.preco}, data-estoque=${p.estoque}" th:text="${p.nome}" th:disabled="${p.estoque <= 0}"></option>
              </select>
            </div>
            <div class="col-sm-3">
              <label for="quantidade-input" class="form-label">Quantidade</label>
              <input type="number" id="quantidade-input" class="form-control" min="1" value="1">
            </div>
            <div class="col-sm-3 d-grid">
              <button type="button" id="add-item-btn" class="btn btn-primary"><i class="bi bi-plus-circle-fill me-1"></i> Adicionar</button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-light">
            <tr><th>Produto</th><th class="text-center">Qtd.</th><th class="text-end">Preço Unit.</th><th class="text-end">Subtotal</th><th class="text-center">Ação</th></tr>
            </thead>
            <tbody id="itens-table-body"></tbody>
          </table>
        </div>
        <div class="d-flex justify-content-end align-items-center mt-4">
          <span class="me-3 fs-5 fw-semibold">Total da Venda:</span>
          <span class="total-display" id="total-venda">R$ 0,00</span>
        </div>
        <div class="row g-2 mt-4">
          <div class="col-6 d-grid"><a class="btn btn-outline-danger" th:href="@{/vendas}">Cancelar</a></div>
          <div class="col-6 d-grid"><button type="submit" id="btn-finalizar-venda" class="btn btn-success" disabled><i class="bi bi-check-circle me-2"></i>Finalizar Venda</button></div>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  const errors = [];
  <th:block th:if="${#fields.hasErrors()}">
    <th:block th:each="err : ${#fields.allErrors()}">errors.push(/*[[${err}]]*/);</th:block>
  </th:block>
  if (errors.length > 0) {
    let errorHtml = '<ul class="list-unstyled text-start mb-0">';
    errors.forEach(e => errorHtml += '<li><i class="bi bi-exclamation-circle-fill text-danger me-2"></i>' + e + '</li>');
    errorHtml += '</ul>';
    Swal.fire({ icon: 'error', title: 'Erro de Validação', html: errorHtml, confirmButtonColor: '#d33' });
  }
  /*]]>*/
</script>
<script>
  $(document).ready(function () {
    let itemIndex = 0;
    let totalVenda = 0.0;
    const btnFinalizar = $('#btn-finalizar-venda');
    const selectCliente = $('#selectCliente');
    const tableBody = $('#itens-table-body');
    function checkFormValidity() {
      const clienteSelecionado = selectCliente.val() !== "";
      const temItens = tableBody.find('tr').length > 0;
      if (clienteSelecionado && temItens) { btnFinalizar.prop('disabled', false); } else { btnFinalizar.prop('disabled', true); }
    }
    selectCliente.on('change', checkFormValidity);
    $('#add-item-btn').on('click', function () {
      const produtoSelect = $('#produto-select');
      const quantidadeInput = $('#quantidade-input');
      const selectedOption = produtoSelect.find('option:selected');
      const produtoId = selectedOption.val();
      const quantidadeAdicionar = parseInt(quantidadeInput.val());
      if (!produtoId) { Swal.fire({ icon: 'warning', title: 'Atenção', text: 'Por favor, selecione um produto.' }); return; }
      if (isNaN(quantidadeAdicionar) || quantidadeAdicionar <= 0) { Swal.fire({ icon: 'warning', title: 'Atenção', text: 'Por favor, insira uma quantidade válida.' }); return; }
      const estoque = parseInt(selectedOption.data('estoque'));
      const nome = selectedOption.data('nome');
      const preco = parseFloat(selectedOption.data('preco'));
      const existingRow = $(`tr[data-produto-id="${produtoId}"]`);
      if (existingRow.length > 0) {
        const quantidadeAtual = parseInt(existingRow.find('.quantidade-val').val());
        const novaQuantidade = quantidadeAtual + quantidadeAdicionar;
        if (novaQuantidade > estoque) { Swal.fire({ icon: 'error', title: 'Estoque Insuficiente!', text: `Você tentou adicionar ${novaQuantidade}, mas só existem ${estoque} em estoque.` }); return; }
        const novoSubtotal = novaQuantidade * preco;
        existingRow.find('.quantidade-display').text(novaQuantidade);
        existingRow.find('.quantidade-val').val(novaQuantidade);
        existingRow.find('.subtotal-display').text(`R$ ${novoSubtotal.toFixed(2).replace('.', ',')}`);
        const subtotalAntigo = parseFloat(existingRow.find('.subtotal-value').val());
        existingRow.find('.subtotal-value').val(novoSubtotal);
        totalVenda = totalVenda - subtotalAntigo + novoSubtotal;
      } else {
        if (quantidadeAdicionar > estoque) { Swal.fire({ icon: 'error', title: 'Estoque Insuficiente!', text: `Você tentou adicionar ${quantidadeAdicionar}, mas só existem ${estoque} em estoque.` }); return; }
        const subtotal = quantidadeAdicionar * preco;
        const newRow = `
                <tr id="item-row-${itemIndex}" data-produto-id="${produtoId}">
                    <td>${nome}<input type="hidden" name="itens[${itemIndex}].produtoId" value="${produtoId}"><input type="hidden" class="subtotal-value" value="${subtotal}"></td>
                    <td class="text-center"><span class="quantidade-display">${quantidadeAdicionar}</span><input type="hidden" class="quantidade-val" name="itens[${itemIndex}].quantidade" value="${quantidadeAdicionar}"></td>
                    <td class="text-end">R$ ${preco.toFixed(2).replace('.', ',')}</td>
                    <td class="text-end subtotal-display">R$ ${subtotal.toFixed(2).replace('.', ',')}</td>
                    <td class="text-center"><button type="button" class="btn btn-danger btn-sm btn-remove-item"><i class="bi bi-trash3-fill"></i></button></td>
                </tr>`;
        tableBody.append(newRow);
        totalVenda += subtotal;
        itemIndex++;
      }
      updateTotalDisplay();
      produtoSelect.val('');
      quantidadeInput.val(1);
      checkFormValidity();
    });
    tableBody.on('click', '.btn-remove-item', function() {
      const row = $(this).closest('tr');
      const subtotalToRemove = parseFloat(row.find('.subtotal-value').val());
      totalVenda -= subtotalToRemove;
      updateTotalDisplay();
      row.remove();
      checkFormValidity();
    });
    function updateTotalDisplay() { $('#total-venda').text(`R$ ${totalVenda.toFixed(2).replace('.', ',')}`); }
    checkFormValidity();
  });
</script>
</body>
</html>