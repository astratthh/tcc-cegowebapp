<!doctype html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ordens de Serviço | Gestão Profissional</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    .main-layout { display: flex; min-height: 100vh; }
    .content-wrapper { flex-grow: 1; padding: 2rem; overflow-y: auto; }
    .card-header { background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
    .table thead th { font-weight: 600; color: #495057; background-color: #f8f9fa; }
    .badge { font-size: 0.8rem; padding: 0.4em 0.7em; }
  </style>
</head>
<body>

<div class="main-layout">
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>
  <div class="content-wrapper">
    <main>
      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

      <div class="card shadow-sm border-0">
        <div class="card-header p-3 d-flex justify-content-between align-items-center">
          <h1 class="h4 mb-0 fw-bold">Gestão de Ordens de Serviço</h1>
          <a class="btn btn-primary d-flex align-items-center gap-2" th:href="@{/ordens-servico/create}">
            <i class="bi bi-plus-lg"></i><span>Nova OS</span>
          </a>
        </div>

        <div class="card-body border-bottom">
          <form th:action="@{/ordens-servico}" method="get" class="row g-3">
            <div class="col-md-3">
              <select name="clienteId" class="form-select">
                <option value="">Todos os Clientes</option>
                <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nome}" th:selected="${c.id == paramClienteId}"></option>
              </select>
            </div>
            <div class="col-md-3">
              <select name="funcionarioId" class="form-select">
                <option value="">Todos os Funcionários</option>
                <option th:each="f : ${funcionarios}" th:value="${f.id}" th:text="${f.nome}" th:selected="${f.id == paramFuncionarioId}"></option>
              </select>
            </div>
            <div class="col-md-3">
              <select name="servicoId" class="form-select">
                <option value="">Todos os Serviços</option>
                <option th:each="s : ${servicos}" th:value="${s.id}" th:text="${s.nome}" th:selected="${s.id == paramServicoId}"></option>
              </select>
            </div>
            <div class="col-md-2">
              <select name="status" class="form-select">
                <option value="">Todos os Status</option>
                <option th:each="s : ${T(com.example.cego_webapp.models.StatusOrdemServico).values()}"
                        th:value="${s.name()}" th:text="${s.descricao}" th:selected="${s.name() == paramStatus}"></option>
              </select>
            </div>
            <div class="col-md-1 d-grid"><button type="submit" class="btn btn-primary">Filtrar</button></div>
          </form>
        </div>

        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
            <tr>
              <th class="ps-4">OS / Entrada</th>
              <th>Cliente / Veículo</th>
              <th>Valor Total</th>
              <th>Status / Pagamento</th> <th class="text-end pe-4">Ações</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="os : ${osPage.content}" class="align-middle">
              <td class="ps-4">
                <div>
                  <div class="fw-bold" th:text="'#' + ${os.id}"></div>
                  <div class="small" th:text="${#temporals.format(os.dataEntrada, 'dd/MM/yyyy HH:mm')}"></div>
                </div>
              </td>
              <td>
                <div class="fw-semibold" th:text="${os.cliente.nome}"></div>
                <div class="small text-muted" th:text="${os.veiculo.placa + ' - ' + os.veiculo.modelo}"></div>
              </td>
              <td class="fw-bold" th:text="${#numbers.formatCurrency(os.valorTotal)}"></td>
              <td>
                <span th:text="${os.status.descricao}" class="badge mb-1"
                      th:classappend="${os.status.name() == 'PENDENTE' ? 'bg-secondary' : os.status.name() == 'EM_ANDAMENTO' ? 'bg-primary' : os.status.name() == 'FINALIZADA' ? 'bg-success' : 'bg-danger'}"></span>
                <div th:if="${os.contaReceber != null}">
                  <span th:if="${os.contaReceber.status.name() == 'PENDENTE'}" class="badge bg-warning-subtle text-warning-emphasis">Aguardando Pag.</span>
                  <span th:if="${os.contaReceber.status.name() == 'RECEBIDA'}" class="badge bg-success-subtle text-success-emphasis">Pago</span>
                </div>
              </td>
              <td class="text-end pe-4" style="white-space: nowrap;">
                <a th:href="@{/ordens-servico/details/{id}(id=${os.id})}" class="btn btn-sm btn-outline-info" title="Detalhes"><i class="bi bi-eye-fill"></i></a>

                <th:block th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).PENDENTE or os.status == T(com.example.cego_webapp.models.StatusOrdemServico).EM_ANDAMENTO}">
                  <a th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).PENDENTE}" th:href="@{/ordens-servico/edit/{id}(id=${os.id})}" class="btn btn-sm btn-outline-secondary ms-1" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                  <form th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).PENDENTE}" th:action="@{/ordens-servico/alterar-status/{id}(id=${os.id})}" method="post" class="d-inline">
                    <input type="hidden" name="novoStatus" value="EM_ANDAMENTO"/>
                    <button type="submit" class="btn btn-sm btn-success ms-1 btn-acao" data-title="Iniciar Serviço?" data-text="A OS será movida para 'Em Andamento'." data-icon="info" data-confirm-text="Sim, iniciar!" title="Iniciar"><i class="bi bi-play-circle-fill"></i></button>
                  </form>
                  <form th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).EM_ANDAMENTO}" th:action="@{/ordens-servico/alterar-status/{id}(id=${os.id})}" method="post" class="d-inline">
                    <input type="hidden" name="novoStatus" value="FINALIZADA"/>
                    <button type="submit" class="btn btn-sm btn-primary ms-1 btn-acao" data-title="Finalizar Serviço?" data-text="A OS será 'Finalizada' e uma Conta a Receber será gerada." data-icon="question" data-confirm-text="Sim, finalizar!" title="Finalizar"><i class="bi bi-check-circle-fill"></i></button>
                  </form>
                  <form th:action="@{/ordens-servico/cancelar/{id}(id=${os.id})}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger ms-1 btn-acao" data-title="Confirmar cancelamento?" data-text="Esta ação não poderá ser desfeita!" data-icon="warning" data-confirm-text="Sim, cancelar!" title="Cancelar"><i class="bi bi-x-circle"></i></button>
                  </form>
                </th:block>
              </td>
            </tr>
            <tr th:if="${osPage.empty}">
              <td colspan="5" class="text-center text-muted p-4">Nenhuma Ordem de Serviço encontrada.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="card-footer bg-white pt-3" th:if="${!osPage.empty && osPage.totalPages > 1}">
          <nav aria-label="Navegação de páginas">
            <ul class="pagination justify-content-center">
              <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/ordens-servico(page=${currentPage - 1}, size=${osPage.size}, clienteId=${paramClienteId}, funcionarioId=${paramFuncionarioId}, status=${paramStatus}, dataInicio=${paramDataInicio}, dataFim=${paramDataFim}, servicoId=${paramServicoId})}">Anterior</a>
              </li>
              <li class="page-item" th:each="i : ${#numbers.sequence(0, osPage.totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link" th:href="@{/ordens-servico(page=${i}, size=${osPage.size}, clienteId=${paramClienteId}, funcionarioId=${paramFuncionarioId}, status=${paramStatus}, dataInicio=${paramDataInicio}, dataFim=${paramDataFim}, servicoId=${paramServicoId})}" th:text="${i + 1}"></a>
              </li>
              <li class="page-item" th:classappend="${currentPage + 1 >= osPage.totalPages} ? 'disabled'">
                <a class="page-link" th:href="@{/ordens-servico(page=${currentPage + 1}, size=${osPage.size}, clienteId=${paramClienteId}, funcionarioId=${paramFuncionarioId}, status=${paramStatus}, dataInicio=${paramDataInicio}, dataFim=${paramDataFim}, servicoId=${paramServicoId})}">Próxima</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.querySelectorAll('.btn-acao').forEach(button => {
    button.addEventListener('click', function (e) { /* ... seu script sweetalert ... */ });
  });
</script>
</body>
</html>