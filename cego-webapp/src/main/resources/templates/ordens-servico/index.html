<!doctype html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ordens de Serviço | Gestão Profissional</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    .main-layout { display: flex; min-height: 100vh; }
    .content-wrapper { flex-grow: 1; padding: 2rem; overflow-y: auto; }
    .card-header { background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
    .table thead th { font-weight: 600; color: #495057; background-color: #f8f9fa; border-bottom-width: 1px; }
    .table-borderless-outside { border-collapse: separate; border-spacing: 0; }
    .table-borderless-outside > :not(caption) > * > * { border-bottom-width: 1px; border-color: #dee2e6; }
    .table-borderless-outside > tbody > tr:last-child > td { border-bottom-width: 0; }
    .badge { font-size: 0.8rem; padding: 0.4em 0.7em; }
  </style>
</head>
<body>

<div class="main-layout">
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>
  <div class="content-wrapper">
    <main>
      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

      <div class="card shadow-sm border-0">
        <div class="card-header p-3 d-flex justify-content-between align-items-center">
          <h1 class="h4 mb-0 fw-bold">Gestão de Ordens de Serviço</h1>
          <a class="btn btn-primary d-flex align-items-center gap-2" th:href="@{/ordens-servico/create}">
            <i class="bi bi-plus-lg"></i><span>Nova OS</span>
          </a>
        </div>

        <div class="table-responsive">
          <table class="table table-hover table-borderless-outside mb-0">
            <thead>
            <tr>
              <th class="ps-4">OS / Entrada</th>
              <th>Cliente / Veículo</th>
              <th>Valor Total</th>
              <th>Status</th>
              <th class="text-end pe-4">Ações</th>
            </tr>
            </thead>
            <tbody class="table-group-divider">
            <tr th:each="os : ${osPage.content}" class="align-middle"
                th:classappend="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).FINALIZADA ? 'table-success-subtle' : (os.status == T(com.example.cego_webapp.models.StatusOrdemServico).CANCELADA ? 'text-muted bg-light' : '')}">
              <td class="ps-4">
                <div>
                  <div class="fw-bold" th:text="'#' + ${os.id}"></div>
                  <div class="small" th:text="${#temporals.format(os.dataEntrada, 'dd/MM/yyyy HH:mm')}"></div>
                </div>
              </td>
              <td>
                <div class="fw-semibold" th:text="${os.cliente.nome}"></div>
                <div class="small text-muted" th:text="${os.veiculo.placa + ' - ' + os.veiculo.modelo}"></div>
              </td>
              <td class="fw-bold" th:text="${#numbers.formatCurrency(os.valorTotal)}"></td>
              <td>
                <span th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).PENDENTE}" class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">Pendente</span>
                <span th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).EM_ANDAMENTO}" class="badge rounded-pill bg-primary-subtle text-primary-emphasis">Em Andamento</span>
                <span th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).FINALIZADA}" class="badge rounded-pill bg-success-subtle text-success-emphasis">Finalizada</span>
                <span th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).CANCELADA}" class="badge rounded-pill bg-danger-subtle text-danger-emphasis">Cancelada</span>
              </td>
              <td class="text-end pe-4" style="white-space: nowrap;">
                <th:block th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).PENDENTE or os.status == T(com.example.cego_webapp.models.StatusOrdemServico).EM_ANDAMENTO}">
                  <form th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).PENDENTE}" th:action="@{/ordens-servico/alterar-status/{id}(id=${os.id})}" method="post" class="d-inline">
                    <input type="hidden" name="novoStatus" value="EM_ANDAMENTO"/>
                    <button type="submit" class="btn btn-sm btn-success btn-acao"
                            data-title="Iniciar Serviço?" data-text="A OS será movida para 'Em Andamento'."
                            data-icon="info" data-confirm-text="Sim, iniciar!">
                      <i class="bi bi-play-circle-fill me-1"></i> Iniciar
                    </button>
                  </form>

                  <form th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).EM_ANDAMENTO}" th:action="@{/ordens-servico/alterar-status/{id}(id=${os.id})}" method="post" class="d-inline">
                    <input type="hidden" name="novoStatus" value="FINALIZADA"/>
                    <button type="submit" class="btn btn-sm btn-primary btn-acao"
                            data-title="Finalizar Serviço?" data-text="A OS será 'Finalizada' e uma Conta a Receber será gerada."
                            data-icon="question" data-confirm-text="Sim, finalizar!">
                      <i class="bi bi-check-circle-fill me-1"></i> Finalizar
                    </button>
                  </form>

                  <form th:action="@{/ordens-servico/cancelar/{id}(id=${os.id})}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger ms-1 btn-acao"
                            data-title="Confirmar cancelamento?" data-text="Esta ação não poderá ser desfeita!"
                            data-icon="warning" data-confirm-text="Sim, cancelar!">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </form>
                </th:block>

                <th:block th:if="${os.status == T(com.example.cego_webapp.models.StatusOrdemServico).FINALIZADA or os.status == T(com.example.cego_webapp.models.StatusOrdemServico).CANCELADA}">
                  <button class="btn btn-sm btn-outline-secondary" disabled>
                    <i class="bi bi-eye-fill me-1"></i> Detalhes
                  </button>
                </th:block>
              </td>
            </tr>
            <tr th:if="${osPage.empty}">
              <td colspan="5" class="text-center text-muted p-4">Nenhuma Ordem de Serviço encontrada.</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="card-footer bg-white pt-3" th:if="${!osPage.empty}">
          <nav aria-label="Navegação de páginas">
            <ul class="pagination justify-content-center">
              <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/ordens-servico(page=${currentPage - 1}, size=${osPage.size})}">Anterior</a>
              </li>
              <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link" th:href="@{/ordens-servico(page=${i}, size=${osPage.size})}" th:text="${i + 1}"></a>
              </li>
              <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                <a class="page-link" th:href="@{/ordens-servico(page=${currentPage + 1}, size=${osPage.size})}">Próxima</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.querySelectorAll('.btn-acao').forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      const form = this.closest('form');
      Swal.fire({
        title: this.dataset.title,
        text: this.dataset.text,
        icon: this.dataset.icon,
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: this.dataset.confirmText,
        cancelButtonText: 'Voltar'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });
</script>
</body>
</html>